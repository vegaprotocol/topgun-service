---

kind: pipeline
name: default
type: docker

platform:
  arch: amd64
  os: linux

steps:
  - name: build
    image: docker.pkg.github.com/vegaprotocol/devops-infra/cipipeline:1.14.4
    pull: always
    volumes:
      - name: gocache
        path: /go/cache
      - name: gopkg
        path: /go/pkg
    environment:
      GO111MODULE: "on"
      GOARCH: amd64
      GOCACHE: /go/cache
      GOOS: linux
    commands:
      - make build-static
    depends_on: []
    when:
      ref:
        - refs/heads/master

  - name: publish_docker
    image: docker.pkg.github.com/vegaprotocol/devops-infra/cipipeline-docker:18.09.7
    volumes:
      - name: dockersock
        path: /run/docker.sock
    environment:
      DOCKER_HOST: unix:///run/docker.sock
      DOCKER_CONFIG_JSON:
        from_secret: dockerconfig
    commands:
      - mkdir -p "$$HOME/.docker" ; echo "$$DOCKER_CONFIG_JSON" >"$$HOME/.docker/config.json" ; unset DOCKER_CONFIG_JSON
      - make docker_push
    depends_on:
      - build
    when:
      ref:
        - refs/heads/master

  - name: deploy
    image: docker.pkg.github.com/vegaprotocol/devops-infra/cipipeline:1.14.4
    volumes: []
    environment:
      DEPLOY_SSH_PRIVKEY:
        from_secret: DEPLOY_SSH_PRIVKEY
      DEPLOY_SSH_KNOWNHOSTS:
        from_secret: DEPLOY_SSH_KNOWNHOSTS
    commands:
      - mkdir -p -m 0700 ~/.ssh
      - if ! echo "$${DEPLOY_SSH_PRIVKEY}" | grep -q "BEGIN [A-Z]* PRIVATE KEY" ; then
          echo "Need env var DEPLOY_SSH_PRIVKEY to have a private key" ; exit 1 ; fi
      - if ! echo "$${DEPLOY_SSH_KNOWNHOSTS}" | grep -q ssh-rsa ; then
          echo "Need env var DEPLOY_SSH_KNOWNHOSTS to have one or more host keys" ; exit 1 ; fi
      - echo "$${DEPLOY_SSH_PRIVKEY}" >~/.ssh/id_rsa ; chmod 0600 ~/.ssh/id_rsa
      - echo "$${DEPLOY_SSH_KNOWNHOSTS}" >~/.ssh/known_hosts ; chmod 0644 ~/.ssh/known_hosts
      - unset DEPLOY_SSH_KNOWNHOSTS DEPLOY_SSH_PRIVKEY
      - ssh dockerrunner@rd.vega.xyz '
          docker pull docker.pkg.github.com/vegaprotocol/topgun-service/topgun-service:latest &&
          docker ps -q --filter name=topgun-service | xargs -r docker stop &&
          docker ps -qa --filter name=topgun-service | xargs -r docker rm &&
          docker run -d --name=topgun-service
            -p 8333:8333
            -v /home/dockerrunner/topgun-service-whitelist.csv:/whitelist.csv
            docker.pkg.github.com/vegaprotocol/topgun-service/topgun-service:latest
              -addr=0.0.0.0:8333
              -endpoint=https://lb.n.vega.xyz/query
              -whitelist=/whitelist.csv'
    depends_on:
      - publish_docker
    when:
      ref:
        - refs/heads/master

volumes:
  - name: dockersock
    host:
      path: /run/docker.sock
  - name: gocache
    host:
      path: /var/lib/drone/volumes/topgun-service/gocache
  - name: gopkg
    host:
      path: /var/lib/drone/volumes/topgun-service/gopkg

image_pull_secrets:
  - dockerconfig
